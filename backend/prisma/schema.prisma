generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mysql"
}

enum Role {
  STUDENT
  LAB_INCHARGE
  ADMIN
  HOD
}

enum xDepartment {
  ELECTRICAL_ENGG
  MECHANICAL_ENGG
  FOOTWEAR_ENGG
  CIVIL_ENGG
  AGRICULTURE_ENGG
  SCIENCE
  ARTS
  COMMERCE
  AYUSH
  ELECTRICAL_TECHNICAL
  AUTOMOBILE_TECHNICAL
  ENGLISH
  OTHER
}

enum ResourceStatus {
  AVAILABLE
  OCCUPIED
  LOST
  UNDER_MAINTENANCE
}

model User {
  id               String  @id @default(cuid())
  email            String  @unique
  name             String
  rollNumber       String? @unique
  enrollmentNumber String? @unique

  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])

  role         Role
  profilePhoto String?
  password     String
  authority    ResourceAuthority?

  tickets Ticket[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Department {
  id   String @id @default(cuid())
  name String @unique

  users               User[]
  resourceAuthorities ResourceAuthority[]
}

model ResourceAuthority {
  id   String @id @default(cuid())
  name String

  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])

  location    String
  description String?

  ownerId String @unique
  ownedBy User   @relation(fields: [ownerId], references: [id])

  resourceCategories ResourceCategory[]
  tickets            Ticket[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ResourceCategory {
  id          String  @id @default(cuid())
  name        String
  description String?

  authorityId       String
  resourceAuthority ResourceAuthority @relation(fields: [authorityId], references: [id])

  isActive Boolean @default(true)

  resources Resource[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, authorityId])
}

model Resource {
  id          String  @id @default(cuid())
  name        String
  description String?
  model       String?

  resourceCategoryId String
  resourceCategory   ResourceCategory @relation(fields: [resourceCategoryId], references: [id])

  isActive Boolean @default(true)
  quantity Int     @default(1)

  status      ResourceStatus @default(AVAILABLE)
  ticketItems TicketItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum TicketItemStatus {
  PENDING // Awaiting authority decision
  ACCEPTED // Reserved for the given time (blocks availability)
  REJECTED // Denied
  ISSUED // Physically issued (authenticity only)
  RETURNED // Completed / released
}

enum TicketStatus {
  PENDING // No item decided yet
  APPROVED // At least one item ACCEPTED
  REJECTED // All items REJECTED
  RESOLVED // All items RETURNED or REJECTED
}

model Ticket {
  id String @id @default(cuid())

  // User who requested the ticket
  requestedUserId String
  requestedUser   User   @relation(fields: [requestedUserId], references: [id])

  // Authority handling the request
  authorityId String
  authority   ResourceAuthority @relation(fields: [authorityId], references: [id])

  // One ticket â†’ many items
  ticketItems TicketItem[]

  // Derived state (never controls availability)
  ticketStatus TicketStatus @default(PENDING)

  // Soft lifecycle control
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TicketItem {
  id String @id @default(cuid())

  // Parent ticket
  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id])

  // Requested resource
  resourceId String
  resource   Resource @relation(fields: [resourceId], references: [id])

  quantity Int

  // Reservation window
  from DateTime
  till DateTime

  // Approval metadata
  approvedBy String?
  approvedAt DateTime?

  // Issue (authenticity / handover)
  issuedBy String?
  issuedAt DateTime?

  // Return (release)
  returnedAt DateTime?
  receivedBy String?

  // Item lifecycle
  status TicketItemStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
